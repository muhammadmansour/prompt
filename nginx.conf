user www-data;
worker_processes auto;
pid /run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    sendfile        on;
    keepalive_timeout 65;
    proxy_cache_path /var/cache/nginx/grc levels=1:2 keys_zone=grc_cache:10m max_size=1g inactive=60m use_temp_path=off;

    # ─────────────────────────────────────────────
    # HTTPS SERVER BLOCKS
    # ─────────────────────────────────────────────

    server {
        server_name murasalat.wathbahs.com;

        location / {
            proxy_pass http://127.0.0.1:5174;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
        }

        listen 443 ssl;
        ssl_certificate /etc/letsencrypt/live/murasalat.wathbahs.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/murasalat.wathbahs.com/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    }

    server {
        server_name watheeq.wathbahs.com;

        location / {
            proxy_pass http://127.0.0.1:5175;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
        }

        listen 443 ssl;
        ssl_certificate /etc/letsencrypt/live/watheeq.wathbahs.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/watheeq.wathbahs.com/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    }

    server {
        server_name qiyas.wathbahs.com;

        location / {
            proxy_pass         http://127.0.0.1:5173;
            proxy_http_version 1.1;
            proxy_set_header   Upgrade $http_upgrade;
            proxy_set_header   Connection "upgrade";
            proxy_set_header   Host $host;

            proxy_no_cache     1;
            proxy_cache_bypass 1;
            add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
            add_header Pragma "no-cache" always;
            add_header Expires 0 always;
        }

        listen 443 ssl;
        ssl_certificate /etc/letsencrypt/live/qiyas.wathbahs.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/qiyas.wathbahs.com/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    }

    server {
        server_name chat.wathbahs.com;

        location / {
            proxy_pass         http://127.0.0.1:5179;
            proxy_http_version 1.1;
            proxy_set_header   Upgrade $http_upgrade;
            proxy_set_header   Connection "upgrade";
            proxy_set_header   Host $host;

            proxy_no_cache     1;
            proxy_cache_bypass 1;
            add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
            add_header Pragma "no-cache" always;
            add_header Expires 0 always;
            proxy_connect_timeout 600;
            proxy_send_timeout    600;
            proxy_read_timeout    600;
            send_timeout          600;
        }

        listen 443 ssl;
        ssl_certificate /etc/letsencrypt/live/chat.wathbahs.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/chat.wathbahs.com/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    }

    server {
        server_name murajae.wathbahs.com;

        location / {
            proxy_pass         http://127.0.0.1:5180;
            proxy_http_version 1.1;
            proxy_set_header   Upgrade $http_upgrade;
            proxy_set_header   Connection "upgrade";
            proxy_set_header   Host $host;

            proxy_no_cache     1;
            proxy_cache_bypass 1;
            add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
            add_header Pragma "no-cache" always;
            add_header Expires 0 always;
        }

        listen 443 ssl;
        ssl_certificate /etc/letsencrypt/live/murajae.wathbahs.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/murajae.wathbahs.com/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    }

    server {
        server_name morakhes.wathbahs.com;

        location / {
            proxy_pass         http://127.0.0.1:5177;
            proxy_http_version 1.1;
            proxy_set_header   Upgrade $http_upgrade;
            proxy_set_header   Connection "upgrade";
            proxy_set_header   Host $host;

            proxy_no_cache     1;
            proxy_cache_bypass 1;
            add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
            add_header Pragma "no-cache" always;
            add_header Expires 0 always;
        }

        listen 443 ssl;
        ssl_certificate /etc/letsencrypt/live/morakhes.wathbahs.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/morakhes.wathbahs.com/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    }

    server {
        server_name marsool.wathbahs.com;

        location / {
            proxy_pass         http://127.0.0.1:5181;
            proxy_http_version 1.1;
            proxy_set_header   Upgrade $http_upgrade;
            proxy_set_header   Connection "upgrade";
            proxy_set_header   Host $host;

            proxy_no_cache     1;
            proxy_cache_bypass 1;
            add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
            add_header Pragma "no-cache" always;
            add_header Expires 0 always;
        }

        listen 443 ssl;
        ssl_certificate /etc/letsencrypt/live/marsool.wathbahs.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/marsool.wathbahs.com/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    }

    server {
        server_name multi-agent.wathbahs.com;

        location / {
            proxy_pass         http://127.0.0.1:8000;
            proxy_http_version 1.1;
            proxy_set_header   Upgrade $http_upgrade;
            proxy_set_header   Connection "upgrade";
            proxy_set_header   Host $host;

            proxy_no_cache     1;
            proxy_cache_bypass 1;
            add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
            add_header Pragma "no-cache" always;
            add_header Expires 0 always;
        }

        listen 443 ssl;
        ssl_certificate /etc/letsencrypt/live/multi-agent.wathbahs.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/multi-agent.wathbahs.com/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    }

    server {
        server_name watheb.wathbahs.com;

        location / {
            proxy_pass         http://127.0.0.1:5184;
            proxy_http_version 1.1;
            proxy_set_header   Upgrade $http_upgrade;
            proxy_set_header   Connection "upgrade";
            proxy_set_header   Host $host;

            proxy_no_cache     1;
            proxy_cache_bypass 1;
            add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
            add_header Pragma "no-cache" always;
            add_header Expires 0 always;
        }

        listen 443 ssl;
        ssl_certificate /etc/letsencrypt/live/watheb.wathbahs.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/watheb.wathbahs.com/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    }

    # ── wathbahs.com (main site → port 8888) ──
    server {
        listen 443 ssl http2;
        listen [::]:443 ssl http2;
        server_name wathbahs.com;

        ssl_certificate /etc/letsencrypt/live/wathbahs.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/wathbahs.com/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

        client_max_body_size 50m;

        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;

        access_log /var/log/nginx/wathbahs.com.access.log;
        error_log /var/log/nginx/wathbahs.com.error.log;

        location ~* \.(html|css|js)$ {
            proxy_pass http://127.0.0.1:8888;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
            add_header Pragma "no-cache" always;
            add_header Expires 0 always;

            proxy_read_timeout 300;
            proxy_connect_timeout 300;
            proxy_send_timeout 300;
        }

        location / {
            proxy_pass http://127.0.0.1:8888;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_no_cache 1;
            proxy_cache_bypass 1;
            add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
            add_header Pragma "no-cache" always;
            add_header Expires 0 always;

            proxy_read_timeout 300;
            proxy_connect_timeout 300;
            proxy_send_timeout 300;
        }

        gzip on;
        gzip_vary on;
        gzip_min_length 1024;
        gzip_proxied expired no-cache no-store private auth;
        gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml application/javascript application/json;
        gzip_disable "MSIE [1-6]\.";
    }

    # ── grc.wathbahs.com (SvelteKit → port 3000, API → port 8000) ──
    server {
        server_name grc.wathbahs.com;
        client_max_body_size 200M;

        gzip on;
        gzip_vary on;
        gzip_proxied any;
        gzip_comp_level 6;
        gzip_min_length 1024;
        gzip_types text/plain text/css text/javascript application/javascript application/json application/xml image/svg+xml font/woff2;

        location /api/ {
            proxy_pass         http://127.0.0.1:8000;
            proxy_http_version 1.1;
            proxy_set_header   Upgrade $http_upgrade;
            proxy_set_header   Connection "upgrade";
            proxy_set_header   Host $host;
            proxy_set_header   X-Real-IP $remote_addr;
            proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header   X-Forwarded-Proto $scheme;
            proxy_connect_timeout 300;
            proxy_send_timeout    300;
            proxy_read_timeout    300;
            send_timeout          300;
            add_header Cache-Control "no-store, no-cache, must-revalidate, max-age=0" always;
        }

        location ^~ /_app/immutable/ {
            proxy_pass         http://127.0.0.1:3000;
            proxy_http_version 1.1;
            proxy_set_header   Host $host;
            proxy_set_header   X-Real-IP $remote_addr;
            proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header   X-Forwarded-Proto $scheme;

            proxy_cache            grc_cache;
            proxy_cache_valid      200 30d;
            proxy_cache_use_stale  error timeout updating http_500 http_502 http_503;
            proxy_ignore_headers   Cache-Control Expires Set-Cookie X-Accel-Expires;
            proxy_hide_header      Set-Cookie;
            proxy_hide_header      Cache-Control;
            add_header Cache-Control "public, max-age=31536000, immutable" always;
            add_header X-Cache $upstream_cache_status always;
        }

        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|webp|avif)$ {
            proxy_pass         http://127.0.0.1:3000;
            proxy_http_version 1.1;
            proxy_set_header   Host $host;
            proxy_set_header   X-Real-IP $remote_addr;
            proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header   X-Forwarded-Proto $scheme;

            proxy_cache            grc_cache;
            proxy_cache_valid      200 7d;
            proxy_cache_use_stale  error timeout updating http_500 http_502 http_503;
            proxy_ignore_headers   Cache-Control Expires Set-Cookie X-Accel-Expires;
            proxy_hide_header      Set-Cookie;
            proxy_hide_header      Cache-Control;
            add_header Cache-Control "public, max-age=604800" always;
            add_header X-Cache $upstream_cache_status always;
        }

        location / {
            proxy_pass http://127.0.0.1:3000;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_cache off;
            add_header Cache-Control "no-store, no-cache, must-revalidate" always;
        }

        listen 443 ssl;
        ssl_certificate /etc/letsencrypt/live/grc.wathbahs.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/grc.wathbahs.com/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    }

    server {
        server_name muraji-v2.wathbahs.com;

        location / {
            proxy_pass         http://127.0.0.1:9999;
            proxy_http_version 1.1;
            proxy_set_header   Upgrade $http_upgrade;
            proxy_set_header   Connection "upgrade";
            proxy_set_header   Host $host;

            proxy_no_cache     1;
            proxy_cache_bypass 1;
            add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
            add_header Pragma "no-cache" always;
            add_header Expires 0 always;
        }

        listen 443 ssl;
        ssl_certificate /etc/letsencrypt/live/muraji-v2.wathbahs.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/muraji-v2.wathbahs.com/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    }

    server {
        server_name murasalat-dga.wathbahs.com;

        location / {
            proxy_pass         http://127.0.0.1:5190;
            proxy_http_version 1.1;
            proxy_set_header   Upgrade $http_upgrade;
            proxy_set_header   Connection "upgrade";
            proxy_set_header   Host $host;

            proxy_no_cache     1;
            proxy_cache_bypass 1;
            add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
            add_header Pragma "no-cache" always;
            add_header Expires 0 always;
        }

        listen 443 ssl;
        ssl_certificate /etc/letsencrypt/live/murasalat-dga.wathbahs.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/murasalat-dga.wathbahs.com/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    }

    server {
        server_name muraji-dev.wathbahs.com;

        location / {
            proxy_pass         http://127.0.0.1:6565;
            proxy_http_version 1.1;
            proxy_set_header   Upgrade $http_upgrade;
            proxy_set_header   Connection "upgrade";
            proxy_set_header   Host $host;

            proxy_no_cache     1;
            proxy_cache_bypass 1;
            add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
            add_header Pragma "no-cache" always;
            add_header Expires 0 always;
        }

        listen 443 ssl;
        ssl_certificate /etc/letsencrypt/live/muraji-dev.wathbahs.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/muraji-dev.wathbahs.com/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    }

    server {
        server_name qyas-v5.wathbahs.com;

        location / {
            proxy_pass         http://127.0.0.1:4346;
            proxy_http_version 1.1;
            proxy_set_header   Upgrade $http_upgrade;
            proxy_set_header   Connection "upgrade";
            proxy_set_header   Host $host;

            proxy_no_cache     1;
            proxy_cache_bypass 1;
            add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
            add_header Pragma "no-cache" always;
            add_header Expires 0 always;
        }

        listen 443 ssl;
        ssl_certificate /etc/letsencrypt/live/qyas-v5.wathbahs.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/qyas-v5.wathbahs.com/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    }

    server {
        server_name manaber-api.wathbahs.com;

        client_max_body_size 200M;
        client_body_timeout 300s;
        client_header_timeout 300s;
        send_timeout 300s;

        location / {
            proxy_pass         http://127.0.0.1:3000;
            proxy_http_version 1.1;
            proxy_set_header Connection '';
            proxy_set_header Host $host;
            proxy_buffering off;
            proxy_cache off;
            proxy_no_cache 1;
            proxy_cache_bypass 1;
            proxy_set_header Accept-Encoding "";
            chunked_transfer_encoding off;
            proxy_read_timeout 1h;
            proxy_send_timeout 1h;
            proxy_connect_timeout 300s;
            add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
            add_header Pragma "no-cache" always;
            add_header Expires 0 always;
        }

        listen 443 ssl;
        ssl_certificate /etc/letsencrypt/live/manaber-api.wathbahs.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/manaber-api.wathbahs.com/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    }

    server {
        server_name baheth.wathbahs.com;

        location / {
            proxy_pass         http://127.0.0.1:5200;
            proxy_http_version 1.1;
            proxy_set_header   Upgrade $http_upgrade;
            proxy_set_header   Connection "upgrade";
            proxy_set_header   Host $host;

            proxy_no_cache     1;
            proxy_cache_bypass 1;
            add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
            add_header Pragma "no-cache" always;
            add_header Expires 0 always;
        }

        listen 443 ssl;
        ssl_certificate /etc/letsencrypt/live/baheth.wathbahs.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/baheth.wathbahs.com/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    }

    server {
        server_name qyas-v3.wathbahs.com;

        location / {
            proxy_pass         http://127.0.0.1:5303;
            proxy_http_version 1.1;
            proxy_set_header   Upgrade $http_upgrade;
            proxy_set_header   Connection "upgrade";
            proxy_set_header   Host $host;

            proxy_no_cache     1;
            proxy_cache_bypass 1;
            add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
            add_header Pragma "no-cache" always;
            add_header Expires 0 always;
        }

        listen 443 ssl;
        ssl_certificate /etc/letsencrypt/live/qyas-v3.wathbahs.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/qyas-v3.wathbahs.com/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    }

    server {
        server_name playground.wathbahs.com;

        location / {
            proxy_pass         http://127.0.0.1:5373;
            proxy_http_version 1.1;
            proxy_set_header   Upgrade $http_upgrade;
            proxy_set_header   Connection "upgrade";
            proxy_set_header   Host $host;

            proxy_no_cache     1;
            proxy_cache_bypass 1;
            add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
            add_header Pragma "no-cache" always;
            add_header Expires 0 always;
        }

        listen 443 ssl;
        ssl_certificate /etc/letsencrypt/live/playground.wathbahs.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/playground.wathbahs.com/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    }

    server {
        server_name playground-kn.wathbahs.com;

        location / {
            proxy_pass         http://127.0.0.1:5501;
            proxy_http_version 1.1;
            proxy_set_header   Upgrade $http_upgrade;
            proxy_set_header   Connection "upgrade";
            proxy_set_header   Host $host;

            proxy_no_cache     1;
            proxy_cache_bypass 1;
            add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
            add_header Pragma "no-cache" always;
            add_header Expires 0 always;
        }

        listen 443 ssl;
        ssl_certificate /etc/letsencrypt/live/playground-kn.wathbahs.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/playground-kn.wathbahs.com/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    }

    server {
        server_name qiyas-dev.wathbahs.com;

        location / {
            proxy_pass         http://127.0.0.1:6173;
            proxy_http_version 1.1;
            proxy_set_header   Upgrade $http_upgrade;
            proxy_set_header   Connection "upgrade";
            proxy_set_header   Host $host;

            proxy_no_cache     1;
            proxy_cache_bypass 1;
            add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
            add_header Pragma "no-cache" always;
            add_header Expires 0 always;
        }

        listen 443 ssl;
        ssl_certificate /etc/letsencrypt/live/qiyas-dev.wathbahs.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/qiyas-dev.wathbahs.com/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    }

    server {
        server_name opengrc.wathbahs.com;
        client_max_body_size 50M;
        root /home/mansourmuhammad37/OpenGRC/public;
        index index.php index.html;

        location / {
            try_files $uri $uri/ /index.php?$query_string;
        }

        location ~ \.php$ {
            include snippets/fastcgi-php.conf;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            include fastcgi_params;
            fastcgi_pass unix:/run/php/php8.4-fpm.sock;
        }

        location ~ /\.ht {
            deny all;
        }

        access_log /var/log/nginx/opengrc.access.log;
        error_log  /var/log/nginx/opengrc.error.log;

        listen 443 ssl;
        ssl_certificate /etc/letsencrypt/live/opengrc.wathbahs.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/opengrc.wathbahs.com/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    }

    server {
        server_name muraji.wathbahs.com;

        location / {
            proxy_pass         http://127.0.0.1:5548;
            proxy_http_version 1.1;
            proxy_set_header   Upgrade $http_upgrade;
            proxy_set_header   Connection "upgrade";
            proxy_set_header   Host $host;

            proxy_no_cache     1;
            proxy_cache_bypass 1;
            add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
            add_header Pragma "no-cache" always;
            add_header Expires 0 always;
        }

        listen 443 ssl;
        ssl_certificate /etc/letsencrypt/live/muraji.wathbahs.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/muraji.wathbahs.com/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    }

    server {
        server_name munsit.wathbahs.com;

        location / {
            proxy_pass         http://127.0.0.1:3232;
            proxy_http_version 1.1;
            proxy_set_header   Upgrade $http_upgrade;
            proxy_set_header   Connection "upgrade";
            proxy_set_header   Host $host;

            proxy_no_cache     1;
            proxy_cache_bypass 1;
            add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
            add_header Pragma "no-cache" always;
            add_header Expires 0 always;
        }

        location /api {
            proxy_pass http://localhost:4949;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        listen 443 ssl;
        ssl_certificate /etc/letsencrypt/live/munsit.wathbahs.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/munsit.wathbahs.com/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    }

    server {
        server_name muraji-separated.wathbahs.com;

        location / {
            proxy_pass         http://127.0.0.1:1919;
            proxy_http_version 1.1;
            proxy_set_header   Upgrade $http_upgrade;
            proxy_set_header   Connection "upgrade";
            proxy_set_header   Host $host;

            proxy_no_cache     1;
            proxy_cache_bypass 1;
            add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
            add_header Pragma "no-cache" always;
            add_header Expires 0 always;
        }

        location /api/ {
            proxy_pass https://muraji-api.wathbahs.com/api/;
            proxy_http_version 1.1;
            proxy_set_header Host muraji-api.wathbahs.com;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_buffering off;
            proxy_read_timeout 1h;
            proxy_send_timeout 1h;
        }

        listen 443 ssl;
        ssl_certificate /etc/letsencrypt/live/muraji-separated.wathbahs.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/muraji-separated.wathbahs.com/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    }

    server {
        server_name muraji-api.wathbahs.com;

        client_max_body_size 200M;
        client_body_timeout 300s;
        client_header_timeout 300s;
        send_timeout 300s;

        location / {
            proxy_pass         http://127.0.0.1:2020;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /api {
            proxy_pass         http://127.0.0.1:2020;
            proxy_http_version 1.1;
            proxy_set_header Connection '';
            proxy_set_header Host $host;
            proxy_buffering off;
            proxy_cache off;
            proxy_no_cache 1;
            proxy_cache_bypass 1;
            proxy_set_header Accept-Encoding "";
            chunked_transfer_encoding off;
            proxy_read_timeout 1h;
            proxy_send_timeout 1h;
            proxy_connect_timeout 300s;
            add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
            add_header Pragma "no-cache" always;
            add_header Expires 0 always;
        }

        location /docs {
            proxy_pass         http://127.0.0.1:2020;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        listen 443 ssl;
        ssl_certificate /etc/letsencrypt/live/muraji-api.wathbahs.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/muraji-api.wathbahs.com/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    }

    server {
        server_name murajae-en.wathbahs.com;

        location / {
            proxy_pass         http://127.0.0.1:7173;
            proxy_http_version 1.1;
            proxy_set_header   Upgrade $http_upgrade;
            proxy_set_header   Connection "upgrade";
            proxy_set_header   Host $host;

            proxy_no_cache     1;
            proxy_cache_bypass 1;
            add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
            add_header Pragma "no-cache" always;
            add_header Expires 0 always;
        }

        listen 443 ssl;
        ssl_certificate /etc/letsencrypt/live/murajae-en.wathbahs.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/murajae-en.wathbahs.com/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    }

    server {
        listen 443 ssl;
        server_name platform.wathbahs.com;

        ssl_certificate /etc/letsencrypt/live/platform.wathbahs.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/platform.wathbahs.com/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

        location /_next/static/ {
            alias /home/mansourmuhammad37/wathba-knUI-v2/.next/static/;
            access_log off;
            expires 1y;
            add_header Cache-Control "public, max-age=31536000, immutable";
        }

        location /_next/ {
            proxy_pass http://127.0.0.1:3007;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }

        location ~* ^/(favicon\.ico|robots\.txt|sitemap\.xml|.*\.(svg|png|jpg|jpeg|gif|webp|ico|woff2?))$ {
            root /home/mansourmuhammad37/wathba-knUI-v2/public;
            try_files $uri =404;
            access_log off;
            expires 7d;
            add_header Cache-Control "public, max-age=604800";
        }

        location / {
            proxy_pass http://127.0.0.1:3007;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_cache_bypass $http_upgrade;
            proxy_read_timeout 300s;
            proxy_send_timeout 300s;
        }
    }

    server {
        server_name qyas-v2.wathbahs.com;

        location / {
            proxy_pass         http://127.0.0.1:5301;
            proxy_http_version 1.1;
            proxy_set_header   Upgrade $http_upgrade;
            proxy_set_header   Connection "upgrade";
            proxy_set_header   Host $host;

            proxy_no_cache     1;
            proxy_cache_bypass 1;
            add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
            add_header Pragma "no-cache" always;
            add_header Expires 0 always;
        }

        listen 443 ssl;
        ssl_certificate /etc/letsencrypt/live/qyas-v2.wathbahs.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/qyas-v2.wathbahs.com/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    }

    server {
        server_name murasalat-dga-v2.wathbahs.com;

        location / {
            proxy_pass         http://127.0.0.1:5201;
            proxy_http_version 1.1;
            proxy_set_header   Upgrade $http_upgrade;
            proxy_set_header   Connection "upgrade";
            proxy_set_header   Host $host;

            proxy_no_cache     1;
            proxy_cache_bypass 1;
            add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
            add_header Pragma "no-cache" always;
            add_header Expires 0 always;
        }

        listen 443 ssl;
        ssl_certificate /etc/letsencrypt/live/murasalat-dga-v2.wathbahs.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/murasalat-dga-v2.wathbahs.com/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    }

    server {
        server_name moh.wathbahs.com;

        location / {
            proxy_pass         http://127.0.0.1:7777;
            proxy_http_version 1.1;
            proxy_set_header   Upgrade $http_upgrade;
            proxy_set_header   Connection "upgrade";
            proxy_set_header   Host $host;

            proxy_no_cache     1;
            proxy_cache_bypass 1;
            add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
            add_header Pragma "no-cache" always;
            add_header Expires 0 always;
        }

        listen 443 ssl;
        ssl_certificate /etc/letsencrypt/live/moh.wathbahs.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/moh.wathbahs.com/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    }

    # ─────────────────────────────────────────────
    # HTTP → HTTPS REDIRECTS (managed by Certbot)
    # ─────────────────────────────────────────────

    server {
        listen 80;
        server_name
            wathbahs.com
            www.wathbahs.com
            qyias.wathbahs.com
            murasalat.wathbahs.com
            watheeq.wathbahs.com
            morakhes.wathbahs.com
            chat.wathbahs.com
            murajae.wathbahs.com
            marsool.wathbahs.com
            watheb.wathbahs.com
            multi-agent.wathbahs.com
            murasalat-dga.wathbahs.com
            manaber-api.wathbahs.com
            baheth.wathbahs.com
            murasalat-dga-v2.wathbahs.com
            qyas-v2.wathbahs.com
            qyas-v3.wathbahs.com
            platform.wathbahs.com
            playground.wathbahs.com
            playground-kn.wathbahs.com
            murajae-v2.wathbahs.com
            murajae-en.wathbahs.com
            moh.wathbahs.com
            muraji-v2.wathbahs.com
            muraji-dev.wathbahs.com
            qyas-v5.wathbahs.com
            qiyas.wathbahs.com
            qiyas-dev.wathbahs.com
            opengrc.wathbahs.com
            munsit.wathbahs.com
            muraji-api.wathbahs.com
            muraji-separated.wathbahs.com
            grc.wathbahs.com
            muraji.wathbahs.com;
        return 301 https://$host$request_uri;
    }
}